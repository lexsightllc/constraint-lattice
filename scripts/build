#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
source "$SCRIPT_DIR/lib.sh"

IMAGE_NAME=${IMAGE_NAME:-constraint-lattice/dev}
IMAGE_TAG=${IMAGE_TAG:-latest}

with_venv
ensure_command python
ensure_command npm
DOCKER_AVAILABLE=true
if ! command -v docker >/dev/null 2>&1; then
  DOCKER_AVAILABLE=false
  log INFO "Docker not available; container image build will be skipped"
fi

log INFO "Building Python distribution artifacts"
python -m build

if [ -d "$REPO_ROOT/dashboard" ]; then
  log INFO "Building dashboard bundle"
  (cd "$REPO_ROOT/dashboard" && npm run build)
fi

if [ "$DOCKER_AVAILABLE" = true ]; then
  log INFO "Building Docker image ${IMAGE_NAME}:${IMAGE_TAG}"
  docker build -f infra/docker/Dockerfile --tag "${IMAGE_NAME}:${IMAGE_TAG}" .
fi
