#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
source "$SCRIPT_DIR/lib.sh"

with_venv
ensure_command pip-audit
ensure_command bandit
ensure_command detect-secrets

log INFO "Running pip-audit"
pip-audit

log INFO "Running Bandit on src/"
bandit -q -r src

if [ -d "$REPO_ROOT/dashboard" ]; then
  ensure_command npm
  log INFO "Running npm audit"
  (cd "$REPO_ROOT/dashboard" && npm audit --audit-level high || true)
fi

log INFO "Scanning for secrets"
detect-secrets scan

log INFO "Security scan completed"
