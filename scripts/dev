#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
# shellcheck source=lib.sh
source "$SCRIPT_DIR/lib.sh"

API_HOST=${API_HOST:-0.0.0.0}
API_PORT=${API_PORT:-8080}
FRONTEND_PORT=${FRONTEND_PORT:-3000}
START_FRONTEND=true

usage() {
  cat <<USAGE
Usage: $(basename "$0") [--api-only]

Launch the local developer environment with automatic reload for the API and dashboard.

Options:
  --api-only   Skip the frontend dashboard and only run the FastAPI service.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --api-only)
      START_FRONTEND=false
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      fail "Unknown option: $1"
      ;;
  esac
done

with_venv
ensure_command uvicorn
if [ "$START_FRONTEND" = true ] && [ -d "$REPO_ROOT/dashboard" ]; then
  ensure_command npm
fi

cleanup() {
  trap - SIGINT SIGTERM EXIT
  if [[ -n "${API_PID:-}" ]]; then
    kill "$API_PID" 2>/dev/null || true
  fi
  if [[ -n "${FRONTEND_PID:-}" ]]; then
    kill "$FRONTEND_PID" 2>/dev/null || true
  fi
}

trap cleanup SIGINT SIGTERM EXIT

log INFO "Starting FastAPI server on ${API_HOST}:${API_PORT}"
uvicorn src.api.main:app --host "$API_HOST" --port "$API_PORT" --reload &
API_PID=$!

if [ "$START_FRONTEND" = true ] && [ -d "$REPO_ROOT/dashboard" ]; then
  log INFO "Starting dashboard on http://localhost:${FRONTEND_PORT}"
  (cd "$REPO_ROOT/dashboard" && npm run dev -- --host 0.0.0.0 --port "$FRONTEND_PORT") &
  FRONTEND_PID=$!
fi

wait -n "$API_PID" "${FRONTEND_PID:-}"
cleanup
